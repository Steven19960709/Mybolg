---
layout: post
title: TCP协议
tags: [Interview,network]
---

这几天国庆假期，真的没有让自己停下来。。。都不知道自己怎样想的。。。明明是放假，就是不出去玩。。是我太懒了吗？？

于是我就找了一些坑一个一个填。今天就讲一下TCP协议的相关知识。

# Internet Introduction

互联网是由一整套协议构成的，TCP是其中的一个协议，有着自己的分工。

<img src="http://s8.51cto.com/wyfs02/M00/52/1F/wKiom1RkCCWTa_RqAAJf_qGuyAU502.jpg-wh_651x-s_1754659787.jpg">

    互联网协议，有五层，分别为应用层，传输层，网络层，连接层，实体层（数据链路层+物理层），越下面的层数越接近硬件，越上面的层数就越接近用户。

<img src="http://ovk2ylefr.bkt.clouddn.com/tcp.png">

<img src="http://s8.51cto.com/wyfs02/M01/52/1F/wKiom1RkCD2DRJ_lAAIRCC8B-nU958.jpg">

上面这张图中，Ethernet以太网是最底层的协议，它不能解决多个局域网通信的问题，于是又IP协议来解决。

IP(网络层）协议定义了一套自己的地址规则，称为IP地址。它实现了路由功能，允许某个局域网的A主机，向另外一个局域网的B主机发送消息。

但是IP协议只是一个地址协议，并不能保证数据包的完整，如果路由去丢包（例如缓存满，新进来的数据包就会丢失）。这个时候就需要发现丢了哪一个包，以及入股重新发送这个包，于是就要靠TCP协议了。

简单说，TCP 协议的作用是，保证数据通信的完整性和可靠性，防止丢包。

# TCP Introduction

TCP(Transmission Control Protocol 传输控制协议)是一种面向连接(连接导向)的、可靠的、 基于IP的传输层协议。TCP在IP报文的协议号是6。

## 重要字段

<img src="http://ovk2ylefr.bkt.clouddn.com/TCP2.png">

这张图听说是十分重要的，我就挑我感觉很重要的字段讲一讲。

- Source Port（源端口）和Destination Port（目的端口）

分别占用16位，表示源端口号和目的端口号;用于区别主机中的不同进程， 而IP地址是用来区分不同的主机的，源端口号和目的端口号配合上IP首部中的源IP地址和目的IP地址就能唯一 的确定一个TCP连接;

- Sequence Number（序号）:

用来标识从TCP发端向TCP收端发送的数据字节流，它表示在这个报文段中的的第一个数据 字节在数据流中的序号;主要用来解决网络报乱序的问题;

- Acknowledgment Number（确认序号）

32位确认序列号包含发送确认的一端所期望收到的下一个序号，因此，确认序号应 当是上次已成功收到数据字节序号加1。不过，只有当标志位中的ACK标志(下面介绍)为1时该确认序列号的字 段才有效。主要用来解决不丢包的问题;

- TCP Flags:TCP首部中有6个标志比特，它们中的多个可同时被设置为1，主要是用于操控TCP的状态机的，依次 为URG，ACK，PSH，RST，SYN，FIN。我就说一下ACK，这个听得很多。

ACK: 这个标志表示应答域有效，就是说前面所说的TCP应答好将会包含在TCP数据包中，有两个取值，0和1，1表示有效，0无效。

SYN：表示同步序号，用来建立连接。SYN标志位和ACK标志位搭配使用，当连接请求的时候，SYN=1， ACK=0;连接被响应的时候，SYN=1，ACK=1;这个标志的数据包经常被用来进行端口扫描。扫描者发送 一个只有SYN的数据包，如果对方主机响应了一个数据包回来 ，就表明这台主机存在这个端口;但是由于这 种扫描方式只是进行TCP三次握手的第一次握手，因此这种扫描的成功表示被扫描的机器不很安全，一台安全 的主机将会强制要求一个连接严格的进行TCP的三次握手;

## 三次握手

这个毋庸多说，肯定是很重要的，面试分分钟会问到。下面就讲一讲（虽然之前已经讲过，但是忘了）

TCP是面向连接的，无论数据传输方向是哪，都必须现在双方之间建立一个连接。在TCP/IP协议中，TCP提过可靠的连接服务，连接是通过三次握手来进行初始化的。目的是同步连接双方的序列号和确认号并交换TCP窗口大小信息。但是在面试中你答这样是远远不足够获取大厂offer的。需要理解一下细节。

<img src="http://s9.51cto.com/wyfs02/M00/52/1F/wKiom1RkCGyDnmDKAARlVYJdLnE985.jpg">

第一次握手：建立连接。客户端发送连接请求报文段，将SYN位置为1，Sequence Number为x;然后，客户端进入SYN_SEND状态，等待服务器的确认;

第二次握手：服务器收到SYN报文段。服务器收到客户端的SYN报文段，需要对这个SYN报文段进行确认，设置Acknowledgment Number为x+1(Sequence Number+1);同时，自己自己还要发送SYN请求信息，将SYN位置为1，Sequence Number为y;服务器端将上述所有信息放到一个报文段(即SYN+ACK报文段)中，一并发送给客户端，此时服务器进入SYN_RECV状态;

第三次握手：客户端收到服务器的SYN+ACK报文段。然后将Acknowledgment Number设置为y+1，向服务器发送ACK报文段，这个报文段发送完毕以后，客户端和服务器端都进入ESTABLISHED状态，完成TCP三次握手。（重点，都达到ESTABLISHED状态，完成三次握手）

完成了三次握手，客户端和服务器端就可以开始传送数据。以上就是TCP三次握手的总体介绍。

### 三次握手的原因

为了防止已失效的连接请求报文段突然又传送到了服务端，因而产生错误。

## 四次挥手

由于TCP连接是全双工的，因此每个方向都必须单独进行关闭。这原则是当一方完成它的数据发送任务后就能发送一个FIN来终止这个方向的连接。收到一个 FIN只意味着这一方向上没有数据流动，一个TCP连接在收到一个FIN后仍能发送数据。首先进行关闭的一方将执行主动关闭，而另一方执行被动关闭。

<img src="http://outu8mec9.bkt.clouddn.com/tcp3.jpg">

过程如下：

（1） TCP客户端发送一个FIN，用来关闭客户到服务器的数据传送。

（2） 服务器收到这个FIN，它发回一个ACK，确认序号为收到的序号加1。和SYN一样，一个FIN将占用一个序号。 

（3） 服务器关闭客户端的连接，发送一个FIN给客户端。

（4） 客户端发回ACK报文确认，并将确认序号设置为收到序号加1。

### 挥手的原因

TCP连接是全双工的
即数据可在两个方向上同时传递)所以进行关闭时每个方向上都要单独进行关闭,这个单方向的关闭就叫半关闭.
关闭的方法是一方完成它的数据传输后,就发送一个FIN来向另一方通告将要终止这个方向的连接.当一端收到一个FIN,它必须
通知应用层TCP连接已终止了这个方向的数据传送,发送FIN通常是应用层进行关闭的结果.

那么今天的内容就讲到这里，希望大家能有所收获。