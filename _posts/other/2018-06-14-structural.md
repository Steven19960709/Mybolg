---
layout: post
title: 前端工程化——构建
tags: [project]
date: 2018-06-14
---

构建是前端工程体系中最繁琐，最复杂的模块，承担着从源代码到可执行代码的转化者角色。webpack是一款功能强大而且可扩展构建工具。

### 面向语言

Node是前端工具得以发展的技术基础，在Node诞生之前，对于前端资源的构建工作知识进行基本的压缩和打包，因为当时前端项目自身复杂的并不高，没有模块化开发，规范转译、CSS预编译等现在看来非常普遍的需求。

在前端工程体系中的角色试讲源代码转化为宿主浏览器可执行的代码，其核心是资源的管理。前端产出资源包括CSS，Js，HTML等，分别对应的源代码则是：

- 领先于浏览器实现的ECMAScript规范编写的JS代码。
- Less/Sass预编译语法编写的CSS代码。
- Jade/EJS/Mustache等模版语法编写的HTML代码

上面的这些源代码是无法在浏览器环境下运行的，构建工作的核心便是将其转化为宿主可执行代码，分别对应：

- ECMAScript规范的转译
- CSS预编译语法转译
- HTML模板渲染

### 面向优化

另外，前端资源的构建还需考虑Web应用的性能因素。例如开发阶段使用模块化开发，每个模块有独立的JS和CSS等文件。如果不作处理将每个文件单独上线的话，无疑会增加客户端http请求的数量，从而影响web应用的性能和用户体验。针对这样的问题，构建还需要包括以下功能：

- 依赖打包——分析文件依赖关系，将同步依赖的文件打包在一起，减少http请求
- 资源注入——比如小于10KB的图片便以为你base64格式嵌入文档，减少一次HTTP请求
- 文件压缩——减少文件体积，缩短请求时间
- hash指纹——通过文件名加入hash指纹，以应对浏览器缓存策略

这些功能的目的是为了提高Web应用的性能和用户体验，可以理解为面向优化的。

### 面向部署

HTML文件中与js，CSS图片等资源是引用与被引用关系。被引用的资源经过构建后同常有以下变动：

- 域名、路径改变。开发环境与线上环境的域名肯定是不同的，不同类型的资源甚至部署在不同的CDN服务器上。
- 文件名改动。经过构建之后文件名被加上hash指纹，内容的改动导致hash指纹的改变。

以上的改动最终会影响HTML文件对呗应用资源的url改变。所以对于HTML的构建需要注意在其引用资源url改变时同步更新，这个功能通常叫做资源定位。

### Babel——真正意义上的JavaScript编译

ECMAScript规范的实现仍远远落后规范更新的速度。即使最新版本的Chrome浏览器目前也没有完全支持ECMAScript2015，但是我们仍能使用最新的ECMAscript规范，因为有了Babel。

Babel的作用简单概括就是将浏览器未实现的ECMAScript规范语法转化为可运行的低版本语法。Babel会根据具体配置参数决定编译输出的具体语法，所有的配置参数均由项目针对的浏览器特性决定，比如兼容IE8要配置Babel将部分ES6语法转化为ES3语法。

但是需要明确的是，对于需求非常简单的小型项目来讲，Babel的意义确实不大。但是随着项目代码亮泽鞥大，Babel将会发挥出与之成正比的效能。

#### 结合Webpack与Babel实现JavaScript构建

将Babel与webpack结合使用可以搭建更完善的构建功能，以打造更加完整的前端工程体系。

babel-loader是Babel官方提供的webpack插件，使用方法与常规的webpack loader插件相似。

    module: {
        rules: [
            {
                test: /\.js$/,
                exclude: /(node_modules | bower_components)/,
                use: {
                    loader: 'babel-loader',
                    options: {
                        presets: ['es2015'],
                        plugins: [
                            require('babel-plugin-transform-object-rest-spread')
                        ]
                    }
                }
            }
        ]
    }

#### babel-preset-env

Babel提供了丰富的preset插件供开发者根据项目需求进行自由搭配，比如上述代码描述的是一个典型的使用babel编译es2015规范的配置。babel-preset-2015插件是一个集合，包含了将ES6转化为ES5对应语法的所有插件。但在实际开发过程中，根据项目针对浏览器不同，部分ES6并不需要全部转化为ES5，例如Chrome59以上的版本，箭头函数以实现，没必要转化了。

babel-preset-env节省我们搭配插件的时间，他可以告诉你他需要兼容的目标浏览器的版本，便于我们针对性的进行开发。

    "presets": [
        [
            "env",
            {
                "target": {
                    "chrome": 59
                }
            }
        ]
    ]

这样我们就不必花费精力去调研项目需要转化那些规范语法，放心使用最新的ECMAScript规范了。

#### babelrc文件

使用babel-loader在webpack上进行配置有个缺陷，就是编译只会匹配test规则的文件。例如test: “/\.js$/”，就只会匹配js结尾的文件。但是有时候我们需要使用框架编写源代码的时候，例如.vue这样过的不是js结尾的文件就是另外的说法了。

这个时候，我们需要使用vue-laoder，这仅仅是第一步，我们还需要使用babelrc文件代替webpack配置中的babel-loader里的options。这样就可以了。

    {
        "presets": [
            ["env", {
            "modules": false,
            "targets": {
                "browsers": ["> 1%", "last 2 versions", "not ie <= 8"]
            }
            }],
            "stage-2"
        ],
        "plugins": ["transform-vue-jsx", "transform-runtime"]
    }

### CSS预编译与PostCss

作为浏览器唯一可识别编写样式的语言，CSS是前端工程师一个非常重要的技能。早期对样式要求并不十分复杂的Web站点只需要少量CSS代码即可。但是现在对CSS要求不断提高，CSS的开发就显得更加重要。

- 浏览器实现不理想甚至方案各一。对CSS兼容处理，就是前端的必备技能。
- CSS的弱编程能力。CSS的简单语法可以让没有任何编程基础的初学者或者设计人员很快上手，但是CSS不支持嵌套，甚至运算、变量、复用等这些几乎是编写复杂代码的必备特性也不支持。

#### CSS预编译器

预编译器的工作原理是提供便捷的语法和特性供开发者编写源代码，随后经过专门的编译工具转化为CSS语法。预编译器有以下几个优点可以提高开发效率。

- 增强编程能力
- 增强代码的可复用性，让CSS符合DRY（Don't repeat yourself）的原则。
- 增强源码可维护性。
- 更便于解决浏览器兼容性。

不同的预编译器特性虽然有所差异，但是核心功能围绕这些目标打造，比如：

- 嵌套
- 变量
- mixin/继承
- 运算
- 模块化

嵌套是所有预编译器都支持的语法特性，也是原生CSS最让开发者头疼的问题之一；mixin/继承是为了解决hack和代码复用；变量和运算增强了源码的可编程能力；模块化的支持同时李玉代码复用和提高源码的可维护性。

#### PostCss

CSS预编译理念与Babel有一定相同支持，最重要的区别是，预编译语法并非规范的CSS，额热歌成一排。由预编译语法编写的源代码不能在任何宿主浏览器运行。PostCSS被业内人士称为CSS的babel。它鼓励开发者使用规范的CSS原生语法编写源代码，然后配置编译器需要兼容的浏览器版本，最后经过编译将源码转化为目标浏览器可用的CSS代码。它提供了丰富的插件用于实现不同场景的编译需求，最常用的就是autoprefixer，sprites等。

PostCSS并不是另一种CSS预编译器，与SASS、Less等预编译器也不冲突。PostCSS与Babel不同之处在于，他所支持的“未来CSS语法”并不是严格的CSS规范，大部分都在cSS4草案阶段。PostCSS也被称为“CSS后编译器”。目前CSS预编译和PostCSS综合在一起使用。

- 使用CSS预编译弥补CSS源码的若编程能力，比如变量、运算、继承、模块化等。
- 使用PostCSS处理针对浏览器的需求，比如autoprefix，自动CSS sprites等。

那么这部分内容就像讲到这，希望大家能有所收获！