---
layout: post
title: 前端工程化——部署
date: 2018-07-01
tags: [project]
---

对于小规模团队，部署可以使用一些简单的工具例如FTP上传工具，将文件传输到指定的服务器上，然后交给运维人员发布上线即可。这种方式简单而且快速。但是对于用户体量巨大的产品和拥有多个分支体系的技术团队，部署工作必须综合考量协作、速度、安全等多方面因素。要实现这样目标，部署就不仅仅是上传文件的行为，而是一套完整的流程。

## 部署流程的设计流程

部署流程的三个设计原则：速度、协作和安全。这三者也是衡量部署流程的3个指标。不同规模、不同结构的团队和项目所侧重的指标有所偏差，比如前端功能由单人负责的小型项目比较侧重于速度，体量庞大的团队侧重于安全和协作。

### 速度——化繁为简

将部署流程工程化的第一步就是化繁为简，用简单自动化的方式取代繁琐的工具使用。必须遵循下面两个原则：

- 可配置化。部署的目标服务器、路径信息应该与项目一一对应，并且可供负责部署的人员进行配置。
- 操作简化。部署行为的操作应该足够简单，而不应该像FTP工具一样每次部署都需要按照固定的流程进行手动操作。

### 协作——代码审查和部署队列

协作的本质是个体或者团体之间的交流互助过程，但凡涉及沟通的问题就不是能够从技术角度单方面解决的。例如：

- 沟通不及时导致得代码不同步
- 控制不严格导致得部署错误覆盖

代码审查是解决代码不同问题的有效且成本最低的途径。以git为例，多名开发人员从同一个dev分支创建各自的feature分值进行开发，约定开发完成之后必须merge到dev分支后才可以进行部署。

使用部署队列的途径加强规范的约束。简单来说，部署队列就是将所有部署请求按照顺序形成一个队列，由专门的部署审查人员负责队列的控制，审查通过则允许部署，否则拒绝此次部署请求，并且之后的部署请求全部被拦截。

### 安全——严格审查和权限控制

保障部署安全最常用的方案是制定严格的审查制度和权限控制规范。

严格审查是在代码审查基础上新增的代码层面的约束，比如检验部署测试环境的代码中是否包含线上API的非法调用，这项工作也可以与单元测试结合，由测试工具自动完成。

权限控制规范下的开发人员和审查人员进行重新分工，开发人员不再具备部署权限，审查人员处严格审查代码以外，还需要执行具体的部署行为，而不是像上文提到的只负责控制队列的进度。例如知道部署额的目标地址并且有权限执行部署行为。

## 前端静态资源的部署策略

### 协商缓存和强制缓存

HTML文件是web站点的唯一入口，所有其他资源必须由HTML文件直接或者间接引用才可以被加载。HTML的特殊性决定了它只能使用协商缓存，其他资源（JS，css等）更适用于强制缓存。这种缓存策略的分配能够保证用户每次访问网站均能够获取到最新的HTML资源，其他资源的更新都能可以直接体现在HTML文档中。只要保证HTML更新的及时性，便等于保证了全站资源的更新效率。

这部分内容就讲到这，希望大家能有所收获！
