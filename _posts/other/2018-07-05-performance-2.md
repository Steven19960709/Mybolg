---
layout: post
title: 性能优化——业务层级
date: 2018-07-05
tags: [share]
---

上一篇文章分别从程序的局部和总体进行了性能优化的介绍，接下来将会从业务层级更宏观的介绍前端性能优化。

## 基本方向

前端性能优化基本有以下几个优化方向：

- 首屏优化
- 内容优化
- 请求优化
- CSS优化
- JS优化
- 图片优化

## 业务层级

### 首屏优化

无论是PC端还是移动端的Web页面，都受到网络和终端及应用性能影响，经常要关注首屏内容展示时间这个指标，它用来衡量是否能够在用户耐心消磨完之前展示出来，很大程度影响用户体验。

首屏时间1~2s是较好的，3s以内基本可以接受，5s已经影响到用户体验。

那么首屏时间的检测途径有以下几个

- 时间戳判断；手动打时间戳判断首屏时间，在HTML文档中对应首屏内容的标签结束位置，使用内联的JavaScript代码记录当前时间戳。
- 根据图片判断；通过寻找首屏区域内最后加载的图片作为首屏的结束时间，这样比较符合网页的实际体验。缺点：如果没有图片，只能使用domready事件代替，如果有图，还得判断是否在首屏内。
- 读屏判断，根据自定义区域内，白屏之后屏幕像素变化到稳定这一过程判断第一屏填充完成，及首屏加载完成，但是干扰因素较多，例如轮播，动画广告等。

#### 优化途径

- 首屏最小化；首屏HTML尽量小，尽可能控制DOM节点数、请求书、外链数、让首屏的可视区域尽快显示出来。
- 首屏元素优化，优化落在首屏内的元素性能和结构，包括基础页，元素请求，图片，js，层次结构等。
- 页面静态化，或者全站网络加速。页面首屏包含了页面基础页时间（第一个请求）以及屏内元素总的DNS解析时间、建立连接时间、SSL握手时间、发出请求时间、重定向时间、内容下载时间等。
- 基础页优化，以静态页面的形式存放，用户相关数据依赖Ajax，比如登录信息。用户信息默认系那是为登录状态，异步获取用户数据后再更新。
- 首屏广告优化，重点减少广告JS的下载次数，减少状态上报次数，避免IFrame。
- 首屏按需加载优化，隐藏tab页，用异步加载的方式，当用户需要的时候采取真正获取信息。
- 统计代码优化，针对用户行为统计代码，进行去除冗余，统一放到首屏后加载。
- 单独合并首屏素材，用Css控制（图片地图），首屏请求最少原则。

### 内容优化

内容优化的目的就是使用尽可能少的内容和更高效的方式来传达更多的信息量，产生更优秀的用户体验。

#### 优化途径

- 可缓存的Ajax。Ajax在浏览器返回新的数据前，旧的数据会被缓存，这样能够有更好的天眼。用客户端语言来判断用户当前的可视区方位，只加载用户可视范围的内容。
- 延迟加载。实行按需加载，集中加载首屏内容，用户不可见区域需要用户下拉滚动条或者翻屏时触发。
- 预加载。在浏览器空闲时，请求将来可能会用到的内容。
- 减少Dom数量。
- 使Iframe数量减少。iframe优点是解决加载缓慢的第三方内容如图标，和广告等的家在问题。
- 使用现代化的布局方式，例如h5中的更加语义化的header，footer标签等。
- 减少HTML大小，上线前压缩，使用膜拜版引擎。

### 请求优化

- 尽量减少http请求次数，通过合并文件，CSS雪碧图减少图像请求，图片地图，内联图像，使用缓存等。
- 减少DNS查找次数。通过缓存Dns查找。
- 避免跳转，不要出现404错误（相当于白走一次http）
- 使用Get来完成Ajax请求。
- favicon.icon要小，而且可缓存。
- 较少请求大小。（去除不必要的cookie，使cookie体积尽量小，设置合理的过期时间）

## 程序级别

### CSS优化

- 把样式表至于顶部
- 避免使用CSS表达式
- 使用外部JavaScript和CSS。（利用浏览器的缓存政策，既可以减少HTML大小，也能减少http请求）

### JavaScript优化

- 把页面置于页面底部
- 剔除重复脚本
- 减少Dom操作
    - 对多次访问的dom节点缓存
    - 使用文档碎片操作dom。
    - 写动画时，使用绝对定位。
- 通过js预加载图片
- 代码执行优化
    - 使用更好的数据结构，例如hash和tree
    - 使用urf-8,避免转码；用array来进行字符串拼接；避免使用eval，关键代码手写for而不是forEach函数；使用缓存计算。
    - 尽量使用局部变量。
    - 控制原型链深度、减少对象嵌套。
    - 减少在函数中使用闭包。（垃圾回收的问题）
    - 多使用正则

### 图片优化

详见这篇文章，click [here](http://leunggabou.com/2018/02/02/Picture-quality/)

需要补充的，就是使用响应式的图片。因为不同分辨率的设备，图片效果不一样，分辨率低，如果使用分辨率高的图会浪费流浪，反之，分辨率高的设备使用低分辨率的图片会导致图片模糊。这个时候，我们需要判断设备分辨率，然后使用合适的图片。

还有就是可以说使用data-url，将图片嵌入到HTML中。可以减少http请求，当然这个是和图片非常小的时候使用。

那么这部分内容就像讲到这了，希望大家能有所收获！